➜  trace-istio-part4 git:(main) ✗ docker run -it --rm --init  --privileged --name bpftrace -h bpftrace \
    --pid host \
    --net host \
    -e SCRIPT_HOME=$SCRIPT_HOME \
    -e PID=$PID \
    -e ENVOY_PID=$PID \
    -e BT=trace-envoy-filter-flow.bt \
    -v /etc/localtime:/etc/localtime:ro \
    -v /sys:/sys:rw \
    -v /usr/src:/usr/src:rw \
    -v /lib/modules:/lib/modules:ro \                                                                                                                                                                                                                              <....
     1  #!usr/bin/bpftrace
     2  /*
     3  IMPORT-ENV: 4215
     4  args: $1=ENVOY_PID
     5  */
     6
     7  /*
     8
     9  #export PODID=`sudo crictl  pods | grep fortio-server | egrep '\bReady' | awk '{print $1}'`
    10  #export CONTAINERID=`sudo crictl ps | grep $PODID | grep istio-proxy |  awk '{print $1}'`
    11
    12  kubectl -n idm-mark exec -it fortio-server -c  istio-proxy  -- bash -c 'ls -l /proc/`pgrep envoy`/ns/pid'
    13  lrwxrwxrwx 1 istio-proxy istio-proxy 0 Mar 31 09:18 /proc/15/ns/pid -> 'pid:[4026532799]'
    14  pgrep envoy | tee /dev/fd/2 | xargs -L 1 -I '{}' sudo ls -l /proc/'{}'/ns 
    15
    16  export PID=4215
    17  export SCRIPT_HOME=`pwd`
    18  export bpftrace_image=cndt-bcc-ub
    19
    20  docker run -it --rm --init  --privileged --name bpftrace -h bpftrace \
    21      --pid host \
    22      --net host \
    23      -e SCRIPT_HOME=$SCRIPT_HOME \
    24      -e PID=$PID \
    25      -e ENVOY_PID=$PID \
    26      -e BT=trace-envoy-filter-flow.bt \
    27      -v /etc/localtime:/etc/localtime:ro \
    28      -v /sys:/sys:rw \
    29      -v /usr/src:/usr/src:rw \
    30      -v /lib/modules:/lib/modules:ro \
    31      -v ${SCRIPT_HOME}:${SCRIPT_HOME}:rw \
    32      $bpftrace_image \
    33      ${SCRIPT_HOME}/warp-bt.sh $PID
    34  */
    35
    36
    37  /*
    38  1. BPF Map 说明:
    39
    40  1.1. range tid map
    41  - @watchedWakeRound[tid]=tid
    42         - sys_exit_accept4
    43  - @fdFired[tid]=$fd;
    44         - uprobe: *FileEventImpl*assignEvents*
    45         - uretprobe: *FileEventImpl*assignEvents*
    46
    47  1.2. fd map
    48  - @fd2sockpair[$fd]=@sockpair[tid]
    49         - sys_exit_accept4
    50         - sys_enter_close
    51  - @fd2sockopt[$fd, $level, $optname, $optval_int] = 1
    52         - sys_enter_setsockopt
    53
    54  - @filterManagerImpl2fd[arg0] = @fdFired[tid]
    55  - @fd2filterManagerImpl[$fd] = arg0
    56  - @fd2filterManagerImpl2[$fd] = arg0
    57
    58  1.3. temp tid map
    59  - @sockpair[tid]=($sk->__sk_common.skc_daddr, $dport, $sk->__sk_common.skc_rcv_saddr, $lport);
    60  - @sockpair_exist[tid]=1
    61  - @watchedIo[tid]=fd
    62
    63  */
    64
    65  #include <linux/in.h>
    66  #include <linux/in6.h>
    67  #include <linux/socket.h>
    68  #include <net/sock.h>
    69  // #include <sys/epoll.h>
    70
    71  // The event argument describes the object linked to the file descriptor fd.  The struct epoll_event is defined as:
    72  // struct epoll_data_t {
    73  //     int          fd;
    74  // };
    75
    76  // struct epoll_event {
    77  //     //a bit mask composed by ORing together zero or more of the following available event types
    78  //     uint32_t     events;      /* Epoll events */
    79
    80  //     struct epoll_data_t data;        /* User data variable */
    81  // };
    82
    83
    84
    85  BEGIN
    86  {
    87          printf("Tracing Envoy. Hit Ctrl-C to end.\n");
    88         printf("#define EPOLL_CTL_ADD 1\n #define EPOLL_CTL_DEL 2\n #define EPOLL_CTL_MOD 3\n");
    89
    90         @epoll_ctl_op[1]="EPOLL_CTL_ADD";
    91         @epoll_ctl_op[2]="EPOLL_CTL_DEL";
    92         @epoll_ctl_op[3]="EPOLL_CTL_MOD";
    93
    94
    95  }
    96
    97  /*
    98  获取 accept 连接时的本地和对端地址。并标记本轮 wakeup 需要监控
    99   */
   100  kretprobe:inet_csk_accept
   101  /pid==$1 /
   102  {
   103          $sk = (struct sock *)retval;
   104          $inet_family = $sk->__sk_common.skc_family;
   105
   106          if ($inet_family == AF_INET || $inet_family == AF_INET6) {
   107                  // initialize variable type:
   108                  $daddr = ntop(0);
   109                  $saddr = ntop(0);
   110                  if ($inet_family == AF_INET) {
   111                          $daddr = ntop($sk->__sk_common.skc_daddr);
   112                          $saddr = ntop($sk->__sk_common.skc_rcv_saddr);
   113                  } else {
   114                          printf("not support IPv6.\n");
   115                          return;
   116                  }
   117
   118                  $lport = $sk->__sk_common.skc_num;
   119
   120                // printf("accept(), port=%d\n", $lport);
   121
   122                //only watch listen port 15006
   123                  if( 15006 != $lport ) { 
   124                          return;
   125                  }
   126
   127                  $dport = $sk->__sk_common.skc_dport;
   128                  $qlen  = $sk->sk_ack_backlog;
   129                  $qmax  = $sk->sk_max_ack_backlog;
   130
   131                  // Destination port is big endian, it must be flipped
   132                  $dport = ($dport >> 8) | (($dport << 8) & 0x00FF00);
   133
   134                printf("OS handshaked TCP:\n");
   135                  time("%H:%M:%S ");
   136                  printf("%-6d %-14s ", pid, comm);
   137                  printf("%-39s %-5d %-39s %-5d ", $daddr, $dport, $saddr,
   138                      $lport);
   139                  printf("%d/%d\n", $qlen, $qmax);
   140
   141                  @sockpair[tid]=($sk->__sk_common.skc_daddr, $dport, $sk->__sk_common.skc_rcv_saddr, $lport);
   142                  @sockpair_exist[tid]=1;
   143
   144                @watchedWakeRound[tid]=tid;
   145          }
   146  }
   147
   148  /**
   149   * 获取新连接的 FD 。并标记本轮 libevent 回调需要监控
   150   */
   151  tracepoint:syscalls:sys_exit_accept4
   152  /pid==$1 && @sockpair_exist[tid] /
   153  {
   154          $fd = args->ret;
   155          if( $fd < 0 ) {
   156                  return;
   157          }
   158          printf("sys_exit_accept4 fd=%d\n", $fd);
   159          @fd2sockpair[$fd]=@sockpair[tid];
   160
   161         @fdFired[tid]=$fd;
   162
   163          delete(@sockpair[tid]);
   164          delete(@sockpair_exist[tid]);
   165         printf("%s \n", ustack());
   166  }
   167
   168  /**
   169   * 记录 FD 的 sockopt
   170   */
   171  tracepoint:syscalls:sys_enter_setsockopt
   172  /pid==$1/
   173  {
   174         // socket opts: https://elixir.bootlin.com/linux/v5.16.3/source/include/uapi/linux/tcp.h#L92     
   175         $level = args->level;
   176         $fd = args->fd;
   177
   178         if( @fd2sockpair[$fd].0 ) {
   179                $optname = args->optname;
   180                $optval = args->optval;
   181                $optval_int = *$optval;
   182                $optlen = args->optlen;
   183                // printf("\n########## setsockopt() ##########\n");
   184                printf("comm:%-16s: setsockopt: level=%d, fd=%d, optname=%d, optval=%d, optlen=%d. \n", comm, $level, $fd, $optname, $optval_int, $optlen);
   185                @fd2sockopt[$fd, $level, $optname, $optval_int] = 1;
   186         }
   187  }
   188
   189
   190
   191  /*
   192  记录 epoll 监听的 FD
   193
   194  cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_epoll_ctl/format
   195   */
   196  tracepoint:syscalls:sys_enter_epoll_ctl
   197  /pid==$1/
   198  {
   199         $fd=args->fd;
   200         $epollEvents = (uint32) (args->event->events);
   201         $op = args->op;
   202         if( @fd2sockpair[$fd].0 ) {
   203
   204                printf("***** elapsed=%d: tid=%d,comm=%s: sys_enter_epoll_ctl, epfd=%d, op=%s, fd=%d, events=0x%x\n", 
   205                       elapsed, tid, comm, args->epfd, @epoll_ctl_op[$op], $fd, $epollEvents);
   206
   207
   208                if( $op == 1/*EPOLL_CTL_ADD*/ || $op == 3/*EPOLL_CTL_MOD*/ ) { //add watch epoll event
   209                       if( $epollEvents & (uint32)0x001 /*EPOLLIN*/ ) {
   210                              printf("EPOLL_CTL_ADD/MOD ReadReady(EPOLLIN)\n");
   211                       }
   212                       if( $epollEvents & (uint32)0x004 /*EPOLLOUT*/ ) {
   213                              printf("EPOLL_CTL_ADD/MOD WriteReady(EPOLLOUT)\n");
   214                       }
   215                       if( $epollEvents & (1u << 31) /*EPOLLET*/ ) {
   216                              printf("EPOLL_CTL_ADD/MOD EdgeTrigger\n");
   217                       }
   218                       printf("%s\n", ustack(30));
   219                }
   220                
   221         } else {
   222                if( @fdFired[tid] ) {//in downstream fd event callback, register upstream event trigger
   223                       printf("***** elapsed=%d: tid=%d,comm=%s: register upstream event trigger:sys_enter_epoll_ctl, epfd=%d, op=%s, fd=%d, events=0x%x\n", 
   224                              elapsed, tid, comm, args->epfd, @epoll_ctl_op[$op], $fd, $epollEvents);
   225
   226
   227                       if( $op == 1/*EPOLL_CTL_ADD*/ || $op == 3/*EPOLL_CTL_MOD*/ ) { //add watch epoll event
   228                              if( $epollEvents & (uint32)0x001 /*EPOLLIN*/ ) {
   229                                     printf("EPOLL_CTL_ADD/MOD ReadReady(EPOLLIN)\n");
   230                              }
   231                              if( $epollEvents & (uint32)0x004 /*EPOLLOUT*/ ) {
   232                                     printf("EPOLL_CTL_ADD/MOD WriteReady(EPOLLOUT)\n");
   233                              }
   234                              if( $epollEvents & (1u << 31) /*EPOLLET*/ ) {
   235                                     printf("EPOLL_CTL_ADD/MOD EdgeTrigger\n");
   236                              }
   237                              printf("%s\n", ustack(60));
   238                       }                     
   239                }
   240         }
   241  }
   242
   243  /*
   244  结束本轮的 wakeRound/runnableRound，并等待下一轮
   245  cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_epoll_wait/format
   246   */
   247  tracepoint:syscalls:sys_enter_epoll_wait
   248  /pid==$1/
   249  {
   250
   251         if( @watchedWakeRound[tid] ) {
   252                $runnableStartTime=@tid2Waketime[tid];
   253                if( $runnableStartTime ) {
   254                       $runableDuaration = elapsed - $runnableStartTime;
   255                       printf("\n******* WAKE-ROUND:END Summary *******\n");
   256                       printf("***** elapsed=%d: tid=%d,comm=%s: sys_enter_epoll_wait, runableDuaration=%d, tid2epollNrFdReady=%d\n", 
   257                              elapsed, tid, comm, $runableDuaration, @tid2epollNrFdReady[tid]);
   258                       $tid_last_epoll_wait_args = @last_epoll_wait_args[tid];
   259                       if( $tid_last_epoll_wait_args.0  ) {
   260                              printf("*** last_epoll_wait_args: epfd=%d, events=%d, maxevents=%d, timeout=%d \n", 
   261                                     $tid_last_epoll_wait_args.0, $tid_last_epoll_wait_args.1, $tid_last_epoll_wait_args.2, $tid_last_epoll_wait_args.3);
   262                       }
   263                       printf("***************************\n\n");
   264                }
   265         }
   266
   267         delete(@tid2Waketime[tid]);
   268         delete(@watchedWakeRound[tid]);
   269         delete(@tid2epollNrFdReady[tid]);
   270
   271         //read in next sys_enter_epoll_wait
   272         @last_epoll_wait_args[tid]=(args->epfd, args->events, args->maxevents, args->timeout);
   273  }
   274
   275  /*
   276  开始本轮 wakeRound/runnableRound
   277  cat /sys/kernel/debug/tracing/events/syscalls/sys_exit_epoll_wait/format
   278   */
   279  tracepoint:syscalls:sys_exit_epoll_wait
   280  /pid==$1/
   281  {
   282         // printf("\n***** elapsed=%d: tid=%d,comm=%s: sys_enter_epoll_wait\n", elapsed, tid, comm);
   283
   284         // printf("epfd: 0x%08lx, events: 0x%08lx, maxevents: 0x%08lx, timeout: 0x%08lx \n", 
   285         //        ((args->epfd)), ((args->events)), ((args->maxevents)), ((args->timeout)) );
   286
   287         @tid2Waketime[tid]=elapsed;
   288         @tid2epollNrFdReady[tid]=args->ret;
   289  }
   290
   291  /*
   292  记录本轮 epoll 事件触发的 FD 级回调开始
   293
   294  Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int fd, short events, void* fileEventImplThis)  !!!NOT!!: FileEventImpl::assignEvents()
   295  C++11 Lambda expressions:
   296  event_assign( &raw_event_, base, fd_, xxx, [](evutil_socket_t, short what, void* arg)-> void {}, this );
   297
   298  event_assign(): https://libevent.org/doc/event_8h.html#a3e49a8172e00ae82959dfe64684eda11
   299         event_assign     (       struct event *  ev,
   300                struct event_base *       base,
   301                evutil_socket_t   fd,
   302                short     events,
   303                event_callback_fn         callback,
   304                void *    callback_arg 
   305         )
   306
   307         https://libevent.org/doc/event_8h.html#aed2307f3d9b38e07cc10c2607322d758
   308         typedef void(* event_callback_fn) (evutil_socket_t, short, void *)
   309                fd        An fd or signal
   310                events    One or more EV_* flags
   311                arg       A user-supplied argument.
   312  */
   313  uprobe:/proc/4215/root/usr/local/bin/envoy:*FileEventImpl*assignEvents*
   314  /pid == $1/ 
   315  {
   316         $fd = arg0;
   317         if( @fd2sockpair[$fd].0 ) {
   318                $libevent_events = arg1;
   319
   320                printf("\n***** elapsed=%d: tid=%d,comm=%s: BEGIN:EventFired:FileEventImpl::assignEvents::eventCallback()\n", elapsed, tid, comm);
   321                printf("FileEventImpl*=%p, fd=%d, events=0x%x\n",arg2, $fd, $libevent_events);
   322
   323                if( $libevent_events & (uint16)0x01 /*EV_TIMEOUT*/ ) {
   324                       printf("libevent: EV_TIMEOUT\n");
   325                }
   326                if( $libevent_events & (uint16)0x02 /*EV_TIMEOUT*/ ) {
   327                       printf("libevent: EV_READ\n");
   328                }
   329                if( $libevent_events & (uint16)0x04 /*EV_TIMEOUT*/ ) {
   330                       printf("libevent: EV_WRITE\n");
   331                }
   332                if( $libevent_events & (uint16)0x20 /*EV_TIMEOUT*/ ) {
   333                       printf("libevent: EV_ET\n");
   334                }
   335                if( $libevent_events & (uint16)0x80 /*EV_TIMEOUT*/ ) {
   336                       printf("libevent: EV_CLOSED\n");
   337                }
   338                
   339                printf("%s\n", kstack);
   340                @fdFired[tid]=$fd;
   341                @watchedWakeRound[tid]=tid;
   342         }
   343  }
   344
   345  /*
   346  记录本轮 epoll 事件触发的 FD 级回调结束
   347  */
   348  uretprobe:/proc/4215/root/usr/local/bin/envoy:*FileEventImpl*assignEvents*
   349  /pid == $1 && @fdFired[tid]/ 
   350  {
   351         printf("\n***** elapsed=%d: tid=%d,comm=%s: END:EventFired\n", elapsed, tid, comm);
   352         delete(@fdFired[tid]);
   353  }
   354
   355
   356  tracepoint:syscalls:sys_enter_read,tracepoint:syscalls:sys_enter_readv,tracepoint:syscalls:sys_enter_recv*
   357  /pid == $1 && @fd2sockpair[args->fd].0/ 
   358  {
   359         @watchedIo[tid]=args->fd;
   360  }
   361
   362  tracepoint:syscalls:sys_exit_read,tracepoint:syscalls:sys_exit_readv,tracepoint:syscalls:sys_exit_recv*
   363  /pid == $1 && @watchedIo[tid]/ 
   364  {
   365         printf("\n***** elapsed=%d: tid=%d,comm=%s: socket_read, probe=%s, fd=%d, ret=%d\n", elapsed, tid, comm, probe, @watchedIo[tid],args->ret);
   366         delete(@watchedIo[tid]);
   367         printf("%s\n", ustack(20));
   368  }
   369
   370
   371  tracepoint:syscalls:sys_enter_write,tracepoint:syscalls:sys_enter_writev
   372  /pid == $1 && @fd2sockpair[args->fd].0/ 
   373  {
   374         @watchedIo[tid]=args->fd;
   375  }
   376
   377  tracepoint:syscalls:sys_exit_write,tracepoint:syscalls:sys_exit_writev
   378  /pid == $1 && @watchedIo[tid]/ 
   379  {
   380         printf("\n***** elapsed=%d: tid=%d,comm=%s: socket_write, probe=%s, fd=%d, ret=%d\n", elapsed, tid, comm, probe, @watchedIo[tid], args->ret);
   381         delete(@watchedIo[tid]);
   382         printf("%s\n", ustack(20));
   383  }
   384
   385
   386  /*
   387  打印 TlsInspector 的所有函数调用
   388  */
   389  uprobe:/proc/4215/root/usr/local/bin/envoy:*TlsInspector*
   390  /pid == $1 && @fdFired[tid]/ 
   391  {
   392         printf("\n***** elapsed=%d: tid=%d,comm=%s: TlsInspector*, probe=%s\n", elapsed, tid, comm, probe);
   393  }
   394
   395  /*
   396  打印连接确认协后的函数调用
   397  */
   398  uprobe:/proc/4215/root/usr/local/bin/envoy:*ConnectionSocketImpl*setRequestedApplicationProtocols*
   399  /pid == $1 && @fdFired[tid]/ 
   400  {
   401         printf("\n***** elapsed=%d: tid=%d,comm=%s: ConnectionSocketImpl::setRequestedApplicationProtocols\n", elapsed, tid, comm);
   402         // printf("%s", ustack);
   403  }
   404
   405  //SslSocket::SslSocket
   406  uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions16TransportSockets3Tls9SslSocketC2ENSt3__110shared_ptrINS_3Ssl7ContextEEENS2_12InitialStateERKNS5_IKNS_7Network22TransportSocketOptionsEEENS4_8functionIFNS5_INS6_10HandshakerEEENS4_10unique_ptrI6ssl_stN4bssl8internal7DeleterISK_EEEEiPNS6_18HandshakeCallbacksEEEE
   407  /pid == $1 && @fdFired[tid]/ 
   408  {
   409         printf("\n***** elapsed=%d: tid=%d,comm=%s: SslSocket*, probe=%s\n", elapsed, tid, comm, probe);
   410         printf("%s\n", ustack(10));
   411  }
   412
   413  // setTransportSocketCallbacks
   414  uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions16TransportSockets3Tls9SslSocket27setTransportSocketCallbacksERNS_7Network24TransportSocketCallbacksE
   415  /pid == $1 && @fdFired[tid]/ 
   416  {
   417         printf("\n***** elapsed=%d: tid=%d,comm=%s: SslSocket*, probe=%s\n", elapsed, tid, comm, probe);
   418         printf("%s\n", ustack(10));
   419  }
   420
   421
   422  // doRead
   423  uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions16TransportSockets3Tls9SslSocket6doReadERNS_6Buffer8InstanceE
   424  /pid == $1 && @fdFired[tid]/ 
   425  {
   426         printf("\n***** elapsed=%d: tid=%d,comm=%s: SslSocket*, probe=%s\n", elapsed, tid, comm, probe);
   427         printf("%s\n", ustack(10));
   428  }
   429
   430
   431  // doWrite
   432  uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions16TransportSockets3Tls9SslSocket7doWriteERNS_6Buffer8InstanceEb
   433  /pid == $1 && @fdFired[tid]/ 
   434  {
   435         printf("\n***** elapsed=%d: tid=%d,comm=%s: SslSocket*, probe=%s\n", elapsed, tid, comm, probe);
   436         printf("%s\n", ustack(10));
   437  }
   438
   439  // onSuccess
   440  uprobe:/proc/4215/root/usr/local/bin/envoy:_ZThn16_N5Envoy10Extensions16TransportSockets3Tls9SslSocket9onSuccessEP6ssl_st
   441  /pid == $1 && @fdFired[tid]/ 
   442  {
   443         printf("\n***** elapsed=%d: tid=%d,comm=%s: SslSocket*, probe=%s\n", elapsed, tid, comm, probe);
   444         printf("%s\n", ustack(10));
   445  }
   446
   447  // connection
   448  uprobe:/proc/4215/root/usr/local/bin/envoy:_ZThn16_NK5Envoy10Extensions16TransportSockets3Tls9SslSocket10connectionEv
   449  /pid == $1 && @fdFired[tid]/ 
   450  {
   451         printf("\n***** elapsed=%d: tid=%d,comm=%s: SslSocket*, probe=%s\n", elapsed, tid, comm, probe);
   452         printf("%s\n", ustack(10));
   453  }
   454
   455  // connection
   456  uprobe:/proc/4215/root/usr/local/bin/envoy:_ZThn16_NK5Envoy10Extensions16TransportSockets3Tls9SslSocket10connectionEv
   457  /pid == $1 && @fdFired[tid]/ 
   458  {
   459         printf("\n***** elapsed=%d: tid=%d,comm=%s: SslSocket*, probe=%s\n", elapsed, tid, comm, probe);
   460         printf("%s\n", ustack(10));
   461  }
   462
   463  /*
   464  打印匹配到的 Network Fitler Chain 名字
   465  void setFilterChainName(absl::string_view filter_chain_name)
   466  */
   467  uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10StreamInfo14StreamInfoImpl18setFilterChainNameEN4absl11string_viewE 
   468  /pid == $1 && @fdFired[tid]/ 
   469  { 
   470  /**
   471  [Assembly 2: Calling convention](https://cs61.seas.harvard.edu/site/2018/Asm2/)
   472
   473  1. A structure argument that fits in a single machine word (64 bits/8 bytes) is passed in a single register.
   474     
   475      Example: `struct small { char a1, a2; }`
   476
   477  2. A structure that fits in two to four machine words (16–32 bytes) is passed in sequential registers, as if it were multiple arguments.
   478     
   479      Example: `struct medium { long a1, a2; }`
   480  */
   481      $filterName = str(reg("si"));
   482      $filterNameLength = reg("dx");
   483
   484      // printf("tid:%d: Got setFilterChainName=%s, lenght=%d\n %s \n", tid, $filterName, $filterNameLength, ustack ); 
   485      printf("comm:%s,tid:%d: Got setFilterChainName=%s, lenght=%d\n", comm, tid, $filterName, $filterNameLength ); 
   486
   487      if( $filterNameLength > 0 ) {
   488          printf("%s\n", ustack(3));
   489      }
   490  }
   491
   492  uprobe:/proc/4215/root/usr/local/bin/envoy:*FilterManagerImpl*onRead*,uprobe:/proc/4215/root/usr/local/bin/envoy:*FilterManagerImpl*onContinueReading*,uprobe:/proc/4215/root/usr/local/bin/envoy:*FilterManagerImpl*addReadFilter*
   493  /pid == $1 && @fdFired[tid]/ 
   494  { 
   495         $fd = @fdFired[tid];
   496         @filterManagerImpl2fd[arg0] = $fd;
   497         if( @fd2filterManagerImpl[$fd] ) {
   498                @fd2filterManagerImpl2[$fd] = arg0;
   499         } else {
   500                @fd2filterManagerImpl[$fd] = arg0;
   501         }
   502         printf("comm:%s,tid:%d: FilterManagerImpl::%s,FilterManagerImpl.this=%p,fd=%d \n", comm, tid, probe, arg0, $fd); 
   503  }
   504
   505  uprobe:/proc/4215/root/usr/local/bin/envoy:*FilterManagerImpl*Write*
   506  /pid == $1 && @filterManagerImpl2fd[arg0]/ 
   507  { 
   508         $fd = @filterManagerImpl2fd[arg0];
   509         printf("comm:%s,tid:%d: FilterManagerImpl::%s,FilterManagerImpl.this=%p,fd=%d \n", comm, tid, probe, arg0, $fd); 
   510  }
   511
   512  uprobe:/proc/4215/root/usr/local/bin/envoy:*attachStreamToClient*
   513  /pid == $1 && @fdFired[tid]/ 
   514  { 
   515         printf("comm:%s,tid:%d: attachStreamToClient: %s \n", comm, tid, probe); 
   516  }
   517
   518  /*
   519  清理关闭的 FD 相关的 Map
   520  cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_close/format
   521  */
   522  tracepoint:syscalls:sys_enter_close
   523  /pid==$1/
   524  {
   525          $fd = args->fd;
   526          if( $fd < 0 ) {
   527                  return;
   528          }
   529         if( @fd2sockpair[$fd].0 ) {
   530                printf("sys_enter_close fd=%d\n", $fd);
   531         }
   532          delete(@fd2sockpair[$fd]);
   533
   534         /////
   535
   536         $filterManagerImpl = @fd2filterManagerImpl[$fd];
   537         if( $filterManagerImpl ) {
   538                printf("delete fd2filterManagerImpl, fd=%d\n", $fd );
   539                delete( @fd2filterManagerImpl[$fd] );
   540         }
   541
   542         if( @filterManagerImpl2fd[$filterManagerImpl] ) {
   543                printf("delete fd2filterManagerImpl=%p\n", $filterManagerImpl );
   544                delete(@filterManagerImpl2fd[$filterManagerImpl]);
   545         }
   546
   547
   548         $filterManagerImpl = @fd2filterManagerImpl2[$fd];
   549         if( $filterManagerImpl ) {
   550                printf("delete fd2filterManagerImpl, fd=%d\n", $fd );
   551                delete( @fd2filterManagerImpl2[$fd] );
   552         }
   553
   554         if( @filterManagerImpl2fd[$filterManagerImpl] ) {
   555                printf("delete fd2filterManagerImpl=%p\n", $filterManagerImpl );
   556                delete(@filterManagerImpl2fd[$filterManagerImpl]);
   557         }
   558
   559
   560  }
   561
   562  END
   563  {
   564         clear(@last_epoll_wait_args);
   565         clear(@tid2Waketime);
   566         clear(@tid2epollNrFdReady);
   567  }
Attaching 128 probes...
Tracing Envoy. Hit Ctrl-C to end.
#define EPOLL_CTL_ADD 1
 #define EPOLL_CTL_DEL 2
 #define EPOLL_CTL_MOD 3
OS handshaked TCP:
07:29:17 4215   wrk:worker_0   172.30.207.129                          47700 172.21.206.232                          15006 0/4096
sys_exit_accept4 fd=41

        accept4+96
        Envoy::Network::IoSocketHandleImpl::accept(sockaddr*, unsigned int*)+82
        Envoy::Network::TcpListenerImpl::onSocketEvent(short)+216
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92
        0x7fffffffe000
        event_base_loop+1953
        Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&, std::__1::function<void ()> const&)+621
        Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::__invoke(void*)+19
        start_thread+217
 

***** elapsed=1572476505: tid=5327,comm=wrk:worker_0: TlsInspector*, probe=uprobe:/proc/4215/root/usr/local/bin/envoy:_ZNSt3__110__function6__funcIZN5Envoy10Extensions15ListenerFilters12TlsInspector25TlsInspectorConfigFactory36createListenerFilterFactoryFromProtoERKN6google8protobuf7MessageERKNS_10shared_ptrINS2_7Network21ListenerFilterMatcherEEERNS2_6Server13Configuration22ListenerFactoryContextEEUlRNSD_21ListenerFilterManagerEE_NS_9allocatorISO_EEFvSN_EEclESN_

***** elapsed=1572498138: tid=5327,comm=wrk:worker_0: TlsInspector*, probe=uprobe:/proc/4215/root/usr/local/bin/envoy:_ZNSt3__128__invoke_void_return_wrapperIvE6__callIJRZN5Envoy10Extensions15ListenerFilters12TlsInspector25TlsInspectorConfigFactory36createListenerFilterFactoryFromProtoERKN6google8protobuf7MessageERKNS_10shared_ptrINS3_7Network21ListenerFilterMatcherEEERNS3_6Server13Configuration22ListenerFactoryContextEEUlRNSE_21ListenerFilterManagerEE_SO_EEEvDpOT_

***** elapsed=1572504945: tid=5327,comm=wrk:worker_0: TlsInspector*, probe=uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions15ListenerFilters12TlsInspector6FilterC1ENSt3__110shared_ptrINS2_6ConfigEEE

***** elapsed=1572508463: tid=5327,comm=wrk:worker_0: TlsInspector*, probe=uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions15ListenerFilters12TlsInspector6FilterC2ENSt3__110shared_ptrINS2_6ConfigEEE

***** elapsed=1572544884: tid=5327,comm=wrk:worker_0: TlsInspector*, probe=uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions15ListenerFilters12TlsInspector6Filter8onAcceptERNS_7Network23ListenerFilterCallbacksE

***** elapsed=1572551565: tid=5327,comm=wrk:worker_0: TlsInspector*, probe=uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions15ListenerFilters12TlsInspector6Filter6onReadEv

***** elapsed=1572566211: tid=5327,comm=wrk:worker_0: socket_read, probe=tracepoint:syscalls:sys_exit_recvfrom, fd=41, ret=89

        recv+108


***** elapsed=1572582597: tid=5327,comm=wrk:worker_0: TlsInspector*, probe=uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions15ListenerFilters12TlsInspector6Filter16parseClientHelloEPKvm

***** elapsed=1572606799: tid=5327,comm=wrk:worker_0: TlsInspector*, probe=uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy10Extensions15ListenerFilters12TlsInspector6FilterD0Ev
comm:wrk:worker_0,tid:5327: Got setFilterChainName=0.0.0.0_8080, lenght=12

        Envoy::StreamInfo::StreamInfoImpl::setFilterChainName(absl::string_view)+0
        Envoy::Server::ActiveTcpSocket::newConnection()+377
        Envoy::Server::ActiveTcpSocket::continueFilterChain(bool)+107

***** elapsed=1572656144: tid=5327,comm=wrk:worker_0: sys_enter_epoll_ctl, epfd=10, op=EPOLL_CTL_ADD, fd=41, events=0x80000005
EPOLL_CTL_ADD/MOD ReadReady(EPOLLIN)
EPOLL_CTL_ADD/MOD WriteReady(EPOLLOUT)
EPOLL_CTL_ADD/MOD EdgeTrigger

        epoll_ctl+14
        epoll_nochangelist_add+54
        evmap_io_add_+421
        event_add_nolock_+603
        event_add+54
        Envoy::Event::FileEventImpl::FileEventImpl(Envoy::Event::DispatcherImpl&, int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)+362
        Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)+284
        Envoy::Network::IoSocketHandleImpl::initializeFileEvent(Envoy::Event::Dispatcher&, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)+126
        Envoy::Network::ConnectionImpl::ConnectionImpl(Envoy::Event::Dispatcher&, std::__1::unique_ptr<Envoy::Network::ConnectionSocket, std::__1::default_delete<Envoy::Network::ConnectionSocket> >&&, std::__1::unique_ptr<Envoy::Network::TransportSocket, std::__1::default_delete<Envoy::Network::TransportSocket> >&&, Envoy::StreamInfo::StreamInfo&, bool)+1026
        Envoy::Network::ServerConnectionImpl::ServerConnectionImpl(Envoy::Event::Dispatcher&, std::__1::unique_ptr<Envoy::Network::ConnectionSocket, std::__1::default_delete<Envoy::Network::ConnectionSocket> >&&, std::__1::unique_ptr<Envoy::Network::TransportSocket, std::__1::default_delete<Envoy::Network::TransportSocket> >&&, Envoy::StreamInfo::StreamInfo&, bool)+107
        Envoy::Event::DispatcherImpl::createServerConnection(std::__1::unique_ptr<Envoy::Network::ConnectionSocket, std::__1::default_delete<Envoy::Network::ConnectionSocket> >&&, std::__1::unique_ptr<Envoy::Network::TransportSocket, std::__1::default_delete<Envoy::Network::TransportSocket> >&&, Envoy::StreamInfo::StreamInfo&)+70
        Envoy::Server::ActiveTcpListener::newConnection(std::__1::unique_ptr<Envoy::Network::ConnectionSocket, std::__1::default_delete<Envoy::Network::ConnectionSocket> >&&, std::__1::unique_ptr<Envoy::StreamInfo::StreamInfo, std::__1::default_delete<Envoy::StreamInfo::StreamInfo> >)+307
        Envoy::Server::ActiveTcpSocket::newConnection()+377
        Envoy::Server::ActiveTcpSocket::continueFilterChain(bool)+107
        Envoy::Server::ActiveTcpListener::onAcceptWorker(std::__1::unique_ptr<Envoy::Network::ConnectionSocket, std::__1::default_delete<Envoy::Network::ConnectionSocket> >&&, bool, bool)+163
        Envoy::Network::TcpListenerImpl::onSocketEvent(short)+856
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92
        0x7fffffffe000
        event_base_loop+1953
        Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&, std::__1::function<void ()> const&)+621
        Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::__invoke(void*)+19
        start_thread+217

comm:wrk:worker_0    : setsockopt: level=6, fd=41, optname=1, optval=1, optlen=4. 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl13addReadFilterENSt3__110shared_ptrINS0_10ReadFilterEEE,FilterManagerImpl.this=0x559f98d38758,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl13addReadFilterENSt3__110shared_ptrINS0_10ReadFilterEEE,FilterManagerImpl.this=0x559f98d38758,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl17onContinueReadingEPNS1_16ActiveReadFilterERNS0_16ReadBufferSourceE,FilterManagerImpl.this=0x559f98d38758,fd=41 

***** elapsed=1574508491: tid=5327,comm=wrk:worker_0: END:EventFired

******* WAKE-ROUND:END Summary *******
***** elapsed=1574559779: tid=5327,comm=wrk:worker_0: sys_enter_epoll_wait, runableDuaration=28287362, tid2epollNrFdReady=1
*** last_epoll_wait_args: epfd=10, events=-1741049344, maxevents=32, timeout=100 
***************************


***** elapsed=1574598072: tid=5327,comm=wrk:worker_0: BEGIN:EventFired:FileEventImpl::assignEvents::eventCallback()
FileEventImpl*=0x559f984420e0, fd=41, events=0x26
libevent: EV_READ
libevent: EV_WRITE
libevent: EV_ET


***** elapsed=1574652509: tid=5327,comm=wrk:worker_0: socket_read, probe=tracepoint:syscalls:sys_exit_readv, fd=41, ret=89

        readv+77
        Envoy::Network::IoSocketHandleImpl::readv(unsigned long, Envoy::Buffer::RawSlice*, unsigned long)+247
        Envoy::Network::IoSocketHandleImpl::read(Envoy::Buffer::Instance&, absl::optional<unsigned long>)+167
        Envoy::Network::RawBufferSocket::doRead(Envoy::Buffer::Instance&)+136
        Envoy::Network::ConnectionImpl::onReadReady()+753
        Envoy::Network::ConnectionImpl::onFileEvent(unsigned int)+879
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92
        0x7fffffffe000
        event_base_loop+1953
        Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&, std::__1::function<void ()> const&)+621
        Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::__invoke(void*)+19
        start_thread+217


***** elapsed=1574686035: tid=5327,comm=wrk:worker_0: socket_read, probe=tracepoint:syscalls:sys_exit_readv, fd=41, ret=-11

        readv+77
        Envoy::Network::IoSocketHandleImpl::readv(unsigned long, Envoy::Buffer::RawSlice*, unsigned long)+247
        Envoy::Network::IoSocketHandleImpl::read(Envoy::Buffer::Instance&, absl::optional<unsigned long>)+167
        Envoy::Network::RawBufferSocket::doRead(Envoy::Buffer::Instance&)+136
        Envoy::Network::ConnectionImpl::onReadReady()+753
        Envoy::Network::ConnectionImpl::onFileEvent(unsigned int)+879
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92
        0x7fffffffe000
        event_base_loop+1953
        Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&, std::__1::function<void ()> const&)+621
        Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::__invoke(void*)+19
        start_thread+217

comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl6onReadEv,FilterManagerImpl.this=0x559f98d38758,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl17onContinueReadingEPNS1_16ActiveReadFilterERNS0_16ReadBufferSourceE,FilterManagerImpl.this=0x559f98d38758,fd=41 
***** elapsed=1574839160: tid=5327,comm=wrk:worker_0: sys_enter_epoll_ctl, epfd=10, op=EPOLL_CTL_DEL, fd=41, events=0x80000005
***** elapsed=1574855086: tid=5327,comm=wrk:worker_0: sys_enter_epoll_ctl, epfd=10, op=EPOLL_CTL_ADD, fd=41, events=0x80002004
EPOLL_CTL_ADD/MOD WriteReady(EPOLLOUT)
EPOLL_CTL_ADD/MOD EdgeTrigger

        epoll_ctl+14
        epoll_nochangelist_add+54
        evmap_io_add_+421
        event_add_nolock_+603
        event_add+54
        Envoy::Network::ConnectionImpl::readDisable(bool)+1077
        Envoy::Http::Http1::ServerConnectionImpl::onMessageCompleteBase()+86
        Envoy::Http::Http1::ConnectionImpl::onMessageComplete()+637
        Envoy::Http::Http1::LegacyHttpParserImpl::Impl::Impl(http_parser_type, void*)::{lambda(http_parser*)#3}::__invoke(http_parser*)+31
        http_parser_execute+7959
        Envoy::Http::Http1::LegacyHttpParserImpl::execute(char const*, int)+31
        Envoy::Http::Http1::ConnectionImpl::dispatchSlice(char const*, unsigned long)+52
        Envoy::Http::Http1::ConnectionImpl::dispatch(Envoy::Buffer::Instance&)+1151
        virtual thunk to Envoy::Http::Http1::ConnectionImpl::dispatch(Envoy::Buffer::Instance&)+21
        Envoy::Http::ConnectionManagerImpl::onData(Envoy::Buffer::Instance&, bool)+76
        Envoy::Network::FilterManagerImpl::onContinueReading(Envoy::Network::FilterManagerImpl::ActiveReadFilter*, Envoy::Network::ReadBufferSource&)+303
        Envoy::Network::ConnectionImpl::onReadReady()+1622
        Envoy::Network::ConnectionImpl::onFileEvent(unsigned int)+879
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92
        0x7fffffffe000
        event_base_loop+1953
        Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&, std::__1::function<void ()> const&)+621
        Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::__invoke(void*)+19
        start_thread+217

***** elapsed=1575586312: tid=5327,comm=wrk:worker_0: register upstream event trigger:sys_enter_epoll_ctl, epfd=10, op=EPOLL_CTL_ADD, fd=42, events=0x80000005
EPOLL_CTL_ADD/MOD ReadReady(EPOLLIN)
EPOLL_CTL_ADD/MOD WriteReady(EPOLLOUT)
EPOLL_CTL_ADD/MOD EdgeTrigger

        epoll_ctl+14
        epoll_nochangelist_add+54
        evmap_io_add_+421
        event_add_nolock_+603
        event_add+54
        Envoy::Event::FileEventImpl::FileEventImpl(Envoy::Event::DispatcherImpl&, int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)+362
        Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)+284
        Envoy::Network::IoSocketHandleImpl::initializeFileEvent(Envoy::Event::Dispatcher&, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)+126
        Envoy::Network::ConnectionImpl::ConnectionImpl(Envoy::Event::Dispatcher&, std::__1::unique_ptr<Envoy::Network::ConnectionSocket, std::__1::default_delete<Envoy::Network::ConnectionSocket> >&&, std::__1::unique_ptr<Envoy::Network::TransportSocket, std::__1::default_delete<Envoy::Network::TransportSocket> >&&, Envoy::StreamInfo::StreamInfo&, bool)+1026
        Envoy::Network::ClientConnectionImpl::ClientConnectionImpl(Envoy::Event::Dispatcher&, std::__1::shared_ptr<Envoy::Network::Address::Instance const> const&, std::__1::shared_ptr<Envoy::Network::Address::Instance const> const&, std::__1::unique_ptr<Envoy::Network::TransportSocket, std::__1::default_delete<Envoy::Network::TransportSocket> >&&, std::__1::shared_ptr<std::__1::vector<std::__1::shared_ptr<Envoy::Network::Socket::Option const>, std::__1::allocator<std::__1::shared_ptr<Envoy::Network::Socket::Option const> > > > const&)+283
        Envoy::Event::DispatcherImpl::createClientConnection(std::__1::shared_ptr<Envoy::Network::Address::Instance const>, std::__1::shared_ptr<Envoy::Network::Address::Instance const>, std::__1::unique_ptr<Envoy::Network::TransportSocket, std::__1::default_delete<Envoy::Network::TransportSocket> >&&, std::__1::shared_ptr<std::__1::vector<std::__1::shared_ptr<Envoy::Network::Socket::Option const>, std::__1::allocator<std::__1::shared_ptr<Envoy::Network::Socket::Option const> > > > const&)+75
        Envoy::Upstream::HostImpl::createConnection(Envoy::Event::Dispatcher&, Envoy::Upstream::ClusterInfo const&, std::__1::shared_ptr<Envoy::Network::Address::Instance const> const&, Envoy::Network::TransportSocketFactory&, std::__1::shared_ptr<std::__1::vector<std::__1::shared_ptr<Envoy::Network::Socket::Option const>, std::__1::allocator<std::__1::shared_ptr<Envoy::Network::Socket::Option const> > > > const&, std::__1::shared_ptr<Envoy::Network::TransportSocketOptions const>)+561
        Envoy::Upstream::HostImpl::createConnection(Envoy::Event::Dispatcher&, std::__1::shared_ptr<std::__1::vector<std::__1::shared_ptr<Envoy::Network::Socket::Option const>, std::__1::allocator<std::__1::shared_ptr<Envoy::Network::Socket::Option const> > > > const&, std::__1::shared_ptr<Envoy::Network::TransportSocketOptions const>) const+126
        non-virtual thunk to Envoy::Upstream::HostImpl::createConnection(Envoy::Event::Dispatcher&, std::__1::shared_ptr<std::__1::vector<std::__1::shared_ptr<Envoy::Network::Socket::Option const>, std::__1::allocator<std::__1::shared_ptr<Envoy::Network::Socket::Option const> > > > const&, std::__1::shared_ptr<Envoy::Network::TransportSocketOptions const>) const+21
        Envoy::Http::ActiveClient::ActiveClient(Envoy::Http::HttpConnPoolImplBase&, unsigned int, unsigned int)+112
        Envoy::Http::Http1::ActiveClient::ActiveClient(Envoy::Http::HttpConnPoolImplBase&)+69
        std::__1::__function::__func<Envoy::Http::Http1::allocateConnPool(Envoy::Event::Dispatcher&, Envoy::Random::RandomGenerator&, std::__1::shared_ptr<Envoy::Upstream::Host const>, Envoy::Upstream::ResourcePriority, std::__1::shared_ptr<std::__1::vector<std::__1::shared_ptr<Envoy::Network::Socket::Option const>, std::__1::allocator<std::__1::shared_ptr<Envoy::Network::Socket::Option const> > > > const&, std::__1::shared_ptr<Envoy::Network::TransportSocketOptions const> const&, Envoy::Upstream::ClusterConnectivityState&)::$_0, std::__1::allocator<Envoy::Http::Http1::allocateConnPool(Envoy::Event::Dispatcher&, Envoy::Random::RandomGenerator&, std::__1::shared_ptr<Envoy::Upstream::Host const>, Envoy::Upstream::ResourcePriority, std::__1::shared_ptr<std::__1::vector<std::__1::shared_ptr<Envoy::Network::Socket::Option const>, std::__1::allocator<std::__1::shared_ptr<Envoy::Network::Socket::Option const> > > > const&, std::__1::shared_ptr<Envoy::Network::TransportSocketOptions const> const&, Envoy::Upstream::ClusterConnectivityState&)::$_0>, std::__1::unique_ptr<Envoy::ConnectionPool::ActiveClient, std::__1::default_delete<Envoy::ConnectionPool::ActiveClient> > (Envoy::Http::HttpConnPoolImplBase*)>::operator()(Envoy::Http::HttpConnPoolImplBase*&&)+40
        Envoy::Http::FixedHttpConnPoolImpl::instantiateActiveClient()+35
        Envoy::ConnectionPool::ConnPoolImplBase::tryCreateNewConnection(float)+1233
        Envoy::ConnectionPool::ConnPoolImplBase::newStream(Envoy::ConnectionPool::AttachContext&)+2001
        non-virtual thunk to Envoy::Http::HttpConnPoolImplBase::newStream(Envoy::Http::ResponseDecoder&, Envoy::Http::ConnectionPool::Callbacks&)+47
        Envoy::Extensions::Upstreams::Http::Http::HttpConnPool::newStream(Envoy::Router::GenericConnectionPoolCallbacks*)+70
        ##补： UpstreamRequest::encodeHeaders(bool end_stream)
        Envoy::Router::Filter::decodeHeaders(Envoy::Http::RequestHeaderMap&, bool)+14120
        Envoy::Http::FilterManager::decodeHeaders(Envoy::Http::ActiveStreamDecoderFilter*, Envoy::Http::RequestHeaderMap&, bool)+334
        Envoy::Http::ConnectionManagerImpl::ActiveStream::decodeHeaders(std::__1::unique_ptr<Envoy::Http::RequestHeaderMap, std::__1::default_delete<Envoy::Http::RequestHeaderMap> >&&, bool)+6139
        Envoy::Http::Http1::ServerConnectionImpl::onMessageCompleteBase()+279
        Envoy::Http::Http1::ConnectionImpl::onMessageComplete()+637
        Envoy::Http::Http1::LegacyHttpParserImpl::Impl::Impl(http_parser_type, void*)::{lambda(http_parser*)#3}::__invoke(http_parser*)+31
        http_parser_execute+7959
        Envoy::Http::Http1::LegacyHttpParserImpl::execute(char const*, int)+31
        Envoy::Http::Http1::ConnectionImpl::dispatchSlice(char const*, unsigned long)+52
        Envoy::Http::Http1::ConnectionImpl::dispatch(Envoy::Buffer::Instance&)+1151
        virtual thunk to Envoy::Http::Http1::ConnectionImpl::dispatch(Envoy::Buffer::Instance&)+21
        Envoy::Http::ConnectionManagerImpl::onData(Envoy::Buffer::Instance&, bool)+76
        Envoy::Network::FilterManagerImpl::onContinueReading(Envoy::Network::FilterManagerImpl::ActiveReadFilter*, Envoy::Network::ReadBufferSource&)+303
        Envoy::Network::ConnectionImpl::onReadReady()+1622
        Envoy::Network::ConnectionImpl::onFileEvent(unsigned int)+879
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92
        0x7fffffffe000
        event_base_loop+1953
        Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&, std::__1::function<void ()> const&)+621
        Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::__invoke(void*)+19
        start_thread+217

comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl13addReadFilterENSt3__110shared_ptrINS0_10ReadFilterEEE,FilterManagerImpl.this=0x559f98f08478,fd=41 

***** elapsed=1576195477: tid=5327,comm=wrk:worker_0: END:EventFired

******* WAKE-ROUND:END Summary *******
***** elapsed=1576212027: tid=5327,comm=wrk:worker_0: sys_enter_epoll_wait, runableDuaration=1630507, tid2epollNrFdReady=1
*** last_epoll_wait_args: epfd=10, events=-1741049344, maxevents=32, timeout=76 
***************************


***** elapsed=1576234349: tid=5327,comm=wrk:worker_0: BEGIN:EventFired:FileEventImpl::assignEvents::eventCallback()
FileEventImpl*=0x559f984420e0, fd=41, events=0x24
libevent: EV_WRITE
libevent: EV_ET


***** elapsed=1576255762: tid=5327,comm=wrk:worker_0: END:EventFired
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl7onWriteEv,FilterManagerImpl.this=0x559f98f08478,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl7onWriteEPNS1_17ActiveWriteFilterERNS0_17WriteBufferSourceE,FilterManagerImpl.this=0x559f98f08478,fd=41 

******* WAKE-ROUND:END Summary *******
***** elapsed=1576363828: tid=5327,comm=wrk:worker_0: sys_enter_epoll_wait, runableDuaration=131249, tid2epollNrFdReady=2
*** last_epoll_wait_args: epfd=10, events=-1741049344, maxevents=32, timeout=48 
***************************

comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl7onWriteEv,FilterManagerImpl.this=0x559f98d38758,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl7onWriteEPNS1_17ActiveWriteFilterERNS0_17WriteBufferSourceE,FilterManagerImpl.this=0x559f98d38758,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl7onWriteEv,FilterManagerImpl.this=0x559f98d38758,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl7onWriteEPNS1_17ActiveWriteFilterERNS0_17WriteBufferSourceE,FilterManagerImpl.this=0x559f98d38758,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl7onWriteEv,FilterManagerImpl.this=0x559f98d38758,fd=41 
comm:wrk:worker_0,tid:5327: FilterManagerImpl::uprobe:/proc/4215/root/usr/local/bin/envoy:_ZN5Envoy7Network17FilterManagerImpl7onWriteEPNS1_17ActiveWriteFilterERNS0_17WriteBufferSourceE,FilterManagerImpl.this=0x559f98d38758,fd=41 
***** elapsed=1579186857: tid=5327,comm=wrk:worker_0: sys_enter_epoll_ctl, epfd=10, op=EPOLL_CTL_DEL, fd=41, events=0x80002004
***** elapsed=1579197378: tid=5327,comm=wrk:worker_0: sys_enter_epoll_ctl, epfd=10, op=EPOLL_CTL_ADD, fd=41, events=0x80000005
EPOLL_CTL_ADD/MOD ReadReady(EPOLLIN)
EPOLL_CTL_ADD/MOD WriteReady(EPOLLOUT)
EPOLL_CTL_ADD/MOD EdgeTrigger

        epoll_ctl+14
        epoll_nochangelist_add+54
        evmap_io_add_+421
        event_add_nolock_+603
        event_add+54
        Envoy::Network::ConnectionImpl::readDisable(bool)+938
        Envoy::Http::Http1::StreamEncoderImpl::~StreamEncoderImpl()+112
        non-virtual thunk to Envoy::Http::Http1::ServerConnectionImpl::onEncodeComplete()+54
        Envoy::Http::Http1::StreamEncoderImpl::endEncode()+166
        Envoy::Http::Http1::StreamEncoderImpl::encodeData(Envoy::Buffer::Instance&, bool)+340
        Envoy::Http::ConnectionManagerImpl::ActiveStream::encodeData(Envoy::Buffer::Instance&, bool)+679
        Envoy::Http::FilterManager::encodeData(Envoy::Http::ActiveStreamEncoderFilter*, Envoy::Buffer::Instance&, bool, Envoy::Http::FilterManager::FilterIterationStartState)+2138
        Envoy::Router::UpstreamRequest::decodeData(Envoy::Buffer::Instance&, bool)+230
        Envoy::Http::ResponseDecoderWrapper::decodeData(Envoy::Buffer::Instance&, bool)+59
        Envoy::Http::ResponseDecoderWrapper::decodeData(Envoy::Buffer::Instance&, bool)+59
        Envoy::Http::Http1::ClientConnectionImpl::onMessageCompleteBase()+619
        Envoy::Http::Http1::ConnectionImpl::onMessageComplete()+637
        Envoy::Http::Http1::LegacyHttpParserImpl::Impl::Impl(http_parser_type, void*)::{lambda(http_parser*)#3}::__invoke(http_parser*)+31
        http_parser_execute+7705
        Envoy::Http::Http1::LegacyHttpParserImpl::execute(char const*, int)+31
        Envoy::Http::Http1::ConnectionImpl::dispatchSlice(char const*, unsigned long)+52
        Envoy::Http::Http1::ConnectionImpl::dispatch(Envoy::Buffer::Instance&)+1151
        Envoy::Http::Http1::ClientConnectionImpl::dispatch(Envoy::Buffer::Instance&)+29
        Envoy::Http::CodecClient::onData(Envoy::Buffer::Instance&)+48
        Envoy::Http::CodecClient::CodecReadFilter::onData(Envoy::Buffer::Instance&, bool)+21
        Envoy::Network::FilterManagerImpl::onContinueReading(Envoy::Network::FilterManagerImpl::ActiveReadFilter*, Envoy::Network::ReadBufferSource&)+303
        Envoy::Network::ConnectionImpl::onReadReady()+1622
        Envoy::Network::ConnectionImpl::onFileEvent(unsigned int)+879
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92


***** elapsed=1579414997: tid=5327,comm=wrk:worker_0: BEGIN:EventFired:FileEventImpl::assignEvents::eventCallback()
FileEventImpl*=0x559f984420e0, fd=41, events=0x24
libevent: EV_WRITE
libevent: EV_ET


***** elapsed=1579519749: tid=5327,comm=wrk:worker_0: socket_write, probe=tracepoint:syscalls:sys_exit_writev, fd=41, ret=4598

        writev+77
        Envoy::Network::IoSocketHandleImpl::writev(Envoy::Buffer::RawSlice const*, unsigned long)+263
        Envoy::Network::IoSocketHandleImpl::write(Envoy::Buffer::Instance&)+107
        Envoy::Network::RawBufferSocket::doWrite(Envoy::Buffer::Instance&, bool)+121
        Envoy::Network::ConnectionImpl::onWriteReady()+1876
        Envoy::Network::ConnectionImpl::onFileEvent(unsigned int)+818
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92
        0x7fffffffe000
        event_base_loop+1953
        Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&, std::__1::function<void ()> const&)+621
        Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::__invoke(void*)+19
        start_thread+217


***** elapsed=1579545916: tid=5327,comm=wrk:worker_0: END:EventFired

******* WAKE-ROUND:END Summary *******
***** elapsed=1579555357: tid=5327,comm=wrk:worker_0: sys_enter_epoll_wait, runableDuaration=141227, tid2epollNrFdReady=1
*** last_epoll_wait_args: epfd=10, events=-1741049344, maxevents=32, timeout=44 
***************************


***** elapsed=1581953625: tid=5327,comm=wrk:worker_0: BEGIN:EventFired:FileEventImpl::assignEvents::eventCallback()
FileEventImpl*=0x559f984420e0, fd=41, events=0x26
libevent: EV_READ
libevent: EV_WRITE
libevent: EV_ET


***** elapsed=1582005614: tid=5327,comm=wrk:worker_0: socket_read, probe=tracepoint:syscalls:sys_exit_readv, fd=41, ret=0

        readv+77
        Envoy::Network::IoSocketHandleImpl::readv(unsigned long, Envoy::Buffer::RawSlice*, unsigned long)+247
        Envoy::Network::IoSocketHandleImpl::read(Envoy::Buffer::Instance&, absl::optional<unsigned long>)+167
        Envoy::Network::RawBufferSocket::doRead(Envoy::Buffer::Instance&)+136
        Envoy::Network::ConnectionImpl::onReadReady()+753
        Envoy::Network::ConnectionImpl::onFileEvent(unsigned int)+879
        std::__1::__function::__func<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5, std::__1::allocator<Envoy::Event::DispatcherImpl::createFileEvent(int, std::__1::function<void (unsigned int)>, Envoy::Event::FileTriggerType, unsigned int)::$_5>, void (unsigned int)>::operator()(unsigned int&&)+65
        Envoy::Event::FileEventImpl::assignEvents(unsigned int, event_base*)::$_1::__invoke(int, short, void*)+92
        0x7fffffffe000
        event_base_loop+1953
        Envoy::Server::WorkerImpl::threadRoutine(Envoy::Server::GuardDog&, std::__1::function<void ()> const&)+621
        Envoy::Thread::ThreadImplPosix::ThreadImplPosix(std::__1::function<void ()>, absl::optional<Envoy::Thread::Options> const&)::{lambda(void*)#1}::__invoke(void*)+19
        start_thread+217

***** elapsed=1582027643: tid=5327,comm=wrk:worker_0: sys_enter_epoll_ctl, epfd=10, op=EPOLL_CTL_DEL, fd=41, events=0x80000005
sys_enter_close fd=41
delete fd2filterManagerImpl, fd=41
delete fd2filterManagerImpl=0x559f98d38758
delete fd2filterManagerImpl, fd=41
delete fd2filterManagerImpl=0x559f98f08478

***** elapsed=1582135032: tid=5327,comm=wrk:worker_0: END:EventFired

******* WAKE-ROUND:END Summary *******
***** elapsed=1582179264: tid=5327,comm=wrk:worker_0: sys_enter_epoll_wait, runableDuaration=243675, tid2epollNrFdReady=1
*** last_epoll_wait_args: epfd=10, events=-1741049344, maxevents=32, timeout=44 
***************************

